name: Setup Installation ID

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.RUNNER_APP_ID }}
          private-key: ${{ secrets.RUNNER_PRIVATE_KEY }}
      
      - name: Get Installation ID
        id: get-install-id
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          INSTALL_ID=$(gh api /repos/${{ github.repository }}/installation --jq '.id')
          echo "installation_id=$INSTALL_ID" >> $GITHUB_OUTPUT
          echo "✅ Installation ID: $INSTALL_ID"
      
      - name: Save Installation ID to Secrets
        env:
          GH_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}
        run: |
          gh secret set GH_INSTALLATION_ID \
            --body "${{ steps.get-install-id.outputs.installation_id }}" \
            --repo ${{ github.repository }}
          echo "✅ Секрет GH_INSTALLATION_ID сохранён"
